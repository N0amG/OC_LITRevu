{% extends "base.html" %}

{% block content %}
<div class="flex flex-col items-center w-full p-6 gap-8">
    <h2 class="text-3xl font-bold text-center">Suivre d'autres utilisateurs</h2>

    <!-- Formulaire de recherche -->
    <div class="w-full max-w-lg">
        <form method="post" class="flex w-full flex-col">
            {% csrf_token %}
            <div class="flex gap-2 items-end">
                <div class="form-control w-full relative">
                    <label class="label">
                        <span class="label-text font-bold">Ajouter un utilisateur</span>
                    </label>
                    {{ form.username }}
                    <ul id="autocomplete-results"
                        class="menu bg-base-100 w-full rounded-box absolute top-full mt-1 z-50 hidden shadow-xl border border-base-200 max-h-60 overflow-y-auto">
                        <!-- Les résultats s'afficheront ici -->
                    </ul>
                </div>
                <button type="submit" class="btn btn-primary">S'abonner</button>
            </div>

            {% for error in form.username.errors %}
            <label class="label">
                <span class="label-text-alt text-error">{{ error }}</span>
            </label>
            {% endfor %}

        </form>

        {% if messages %}
        <div class="toast toast-top toast-end">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="divider"></div>

    <!-- Abonnements -->
    <div class="w-full max-w-2xl">
        <h3 class="text-xl font-bold mb-4 text-center">Abonnements</h3>
        <div class="overflow-x-auto">
            <table class="table w-full bg-base-100 shadow-xl rounded-box">
                <tbody>
                    {% for follow in following %}
                    <tr class="hover">
                        <td class="font-bold">{{ follow.followed_user.username }}</td>
                        <td class="text-right flex gap-2 justify-end">
                            <form method="post" action="{% url 'unfollow_user' follow.followed_user.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline btn-warning">Désabonner</button>
                            </form>
                            <form method="post" action="{% url 'block_user' follow.followed_user.id %}"
                                onsubmit="return confirm('Voulez-vous vraiment bloquer cet utilisateur ?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline btn-error">Bloquer</button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="text-center text-gray-500">Vous ne suivez personne pour le moment.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Abonnés -->
    <div class="w-full max-w-2xl">
        <h3 class="text-xl font-bold mb-4 text-center">Abonnés</h3>
        <div class="overflow-x-auto">
            <table class="table w-full bg-base-100 shadow-xl rounded-box">
                <tbody>
                    {% for follow in followers %}
                    <tr class="hover">
                        <td class="font-bold">{{ follow.user.username }}</td>
                        <td class="text-right flex gap-2 justify-end">
                            <form method="post" action="{% url 'remove_follower' follow.user.id %}"
                                onsubmit="return confirm('Voulez-vous vraiment retirer cet abonné ?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline btn-warning">Retirer</button>
                            </form>
                            <form method="post" action="{% url 'block_user' follow.user.id %}"
                                onsubmit="return confirm('Voulez-vous vraiment bloquer cet utilisateur ?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline btn-error">Bloquer</button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td class="text-center text-gray-500">Personne ne vous suit pour le moment.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if blocked_users %}
    <!-- Utilisateurs bloqués -->
    <div class="w-full max-w-2xl">
        <h3 class="text-xl font-bold mb-4 text-center text-error">Utilisateurs bloqués</h3>
        <div class="overflow-x-auto">
            <table class="table w-full bg-base-100 shadow-xl rounded-box">
                <tbody>
                    {% for block in blocked_users %}
                    <tr class="hover">
                        <td class="font-bold">{{ block.blocked_user.username }}</td>
                        <td class="text-right">
                            <form method="post" action="{% url 'unblock_user' block.blocked_user.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline btn-success">Débloquer</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="mt-4">
        <a href="{% url 'home' %}" class="btn btn-ghost">Retour à l'accueil</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.querySelector('input[name="username"]');
        const resultsList = document.getElementById('autocomplete-results');
        let timeoutId;

        function fetchUsers(query) {
            fetch(`{% url 'search_users' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    resultsList.innerHTML = '';
                    if (data.length > 0) {
                        resultsList.classList.remove('hidden');
                        data.forEach(user => {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.textContent = user.username;
                            a.href = "#";
                            a.addEventListener('click', (e) => {
                                e.preventDefault();
                                input.value = user.username;
                                resultsList.classList.add('hidden');
                            });
                            li.appendChild(a);
                            resultsList.appendChild(li);
                        });
                    } else {
                        resultsList.classList.add('hidden');
                    }
                });
        }

        input.addEventListener('focus', function () {
            fetchUsers(this.value);
        });

        input.addEventListener('input', function () {
            clearTimeout(timeoutId);
            const query = this.value;

            timeoutId = setTimeout(() => {
                fetchUsers(query);
            }, 300);
        });

        // Cacher la liste si on clique ailleurs
        document.addEventListener('click', function (e) {
            if (e.target !== input && !resultsList.contains(e.target)) {
                resultsList.classList.add('hidden');
            }
        });
    });
</script>
{% endblock %}