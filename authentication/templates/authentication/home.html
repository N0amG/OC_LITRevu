{% extends "base.html" %}

{% block content %}
<div class="flex flex-col items-center w-full p-6 gap-6">
    <div class="flex justify-between w-full max-w-4xl gap-2 items-center">
        <a href="{% url 'follow_users' %}" class="btn btn-accent">Abonnements</a>
        <a href="{% url 'create_ticket' %}" class="btn btn-primary">Demander une critique</a>
        <a href="{% url 'create_ticket_and_review' %}" class="btn btn-secondary">Créer une critique</a>
        <a href="{% url 'logout' %}" class="btn btn-outline btn-error">Se déconnecter</a>
    </div>

    <div class="w-full max-w-3xl flex flex-col gap-8">
        {% for post in feed %}
            {% if post.content_type == 'TICKET' %}
            <!-- Le Ticket -->
            <div class="card bg-base-200 shadow-xl border-l-4 border-primary">
                <div class="card-body">
                    <div class="flex justify-between items-start">
                        <h2 class="card-title">Ticket: {{ post.title }}</h2>
                        <span class="text-xs text-gray-500">{{ post.time_created|date:"d/m/Y H:i" }}</span>
                    </div>
                    <p class="text-sm text-gray-600">Demandé par {{ post.user.username }}</p>
                    <p class="mt-2">{{ post.description }}</p>
                    {% if post.image %}
                    <figure class="mt-4">
                        <img src="{{ post.image.url }}" alt="{{ post.title }}" class="max-h-64 rounded-lg shadow-md" />
                    </figure>
                    {% endif %}

                    <div class="card-actions justify-end mt-4">
                        <a href="{% url 'create_review' post.id %}" class="btn btn-sm btn-primary">Répondre</a>
                        {% if post.user == request.user %}
                        <a href="{% url 'update_ticket' post.id %}" class="btn btn-sm btn-ghost">Modifier</a>
                        {% endif %}
                        {% if post.user == request.user or request.user.is_superuser %}
                        <a href="{% url 'delete_ticket' post.id %}"
                            class="btn btn-sm btn-ghost text-error">Supprimer</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% elif post.content_type == 'REVIEW' %}
            <!-- La Review -->
            <div class="card bg-base-100 border border-base-300 shadow-sm">
                <div class="card-body p-4">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-lg">{{ post.headline }}</h3>
                        <div class="badge badge-outline badge-warning gap-1 font-bold">
                            ★ {{ post.rating }}
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mb-2">
                        Par {{ post.user.username }} le {{ post.time_created|date:"d/m/Y H:i" }}
                    </div>
                    
                    <!-- Ticket Context -->
                    <div class="bg-base-200 p-3 rounded-lg my-2 text-sm">
                        <p class="font-semibold">Ticket: {{ post.ticket.title }}</p>
                        <p class="text-gray-600 truncate">{{ post.ticket.description }}</p>
                        {% if post.ticket.image %}
                        <figure class="mt-2">
                            <img src="{{ post.ticket.image.url }}" alt="{{ post.ticket.title }}" class="max-h-32 rounded shadow-sm" />
                        </figure>
                        {% endif %}
                    </div>

                    <p class="text-sm">{{ post.body }}</p>

                    <div class="card-actions justify-end mt-2">
                        {% if post.user == request.user %}
                        <a href="{% url 'update_review' post.id %}" class="btn btn-xs btn-ghost">Modifier</a>
                        {% endif %}
                        {% if post.user == request.user or request.user.is_superuser %}
                        <a href="{% url 'delete_review' post.id %}"
                            class="btn btn-xs btn-ghost text-error">Supprimer</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        {% empty %}
        <div class="text-center text-gray-500 mt-10">
            <p>Aucun billet ou commentaire pour le moment.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}